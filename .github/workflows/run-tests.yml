name: ğŸ§ª ìë™í™” í…ŒìŠ¤íŠ¸ ì‹¤í–‰

on:
  workflow_dispatch:
    inputs:
      test_target:
        description: 'ğŸ“‹ í…ŒìŠ¤íŠ¸ ì„ íƒ'
        required: true
        type: choice
        default: 'ğŸ¯ ì „ì²´ í…ŒìŠ¤íŠ¸'
        options:
          - 'ğŸ¯ ì „ì²´ í…ŒìŠ¤íŠ¸'
          - 'ğŸ‘¤ êµ¬ì„±ì› (User)'
          - 'ğŸ“‡ ì™¸ë¶€ ì—°ë½ì²˜ (Contact)'
          - 'ğŸ‘¥ ê·¸ë£¹ (Group)'
          - 'ğŸŒ ì™¸ë¶€ ê·¸ë£¹ (External Group)'
          - 'ğŸ¢ ì¡°ì§ (OrgUnit)'
          - 'ğŸ’¼ ì§ì±… (Position)'
          - 'ğŸ“Š ì§ê¸‰ (Level)'
          - 'ğŸ“Œ ìƒíƒœ (Status)'
          - 'ğŸ‘” ì‚¬ìš©ì ìœ í˜• (UserType)'
          - 'ğŸ·ï¸ íšŒì‚¬ íƒœê·¸ (Company Tag)'
          - 'ğŸ“ MY íƒœê·¸ (MY Tag)'
          - 'ğŸ“ ì—°ë½ì²˜ ì»¤ìŠ¤í…€ í•„ë“œ (Contact Custom Field)'
          - 'ğŸ‘¨â€ğŸ’¼ êµ¬ì„±ì› ì»¤ìŠ¤í…€ í•„ë“œ (Users Custom Field)'
      
      instance:
        description: 'ğŸ–¥ï¸ ì¸ìŠ¤í„´ìŠ¤'
        required: true
        type: choice
        default: 'kr1'
        options:
          - kr1
          - jp1
          - jp2

jobs:
  # ë¸Œëœì¹˜ ê²€ì¦ Job
  validate-branch:
    runs-on: ubuntu-latest
    name: ğŸ” ë¸Œëœì¹˜ ê²€ì¦
    
    steps:
      - name: âœ… real ë¸Œëœì¹˜ í™•ì¸
        if: github.ref_name == 'real'
        run: |
          echo "### âœ… ë¸Œëœì¹˜ ê²€ì¦ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "í˜„ì¬ ë¸Œëœì¹˜: **${{ github.ref_name }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "real ë¸Œëœì¹˜ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
      
      - name: âŒ real ë¸Œëœì¹˜ê°€ ì•„ë‹˜ - í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨
        if: github.ref_name != 'real'
        run: |
          echo "### âŒ ë¸Œëœì¹˜ ê²€ì¦ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**í˜„ì¬ ë¸Œëœì¹˜: \`${{ github.ref_name }}\`**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ ì˜¤ë¥˜: real ë¸Œëœì¹˜ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ì´ ì›Œí¬í”Œë¡œìš°ëŠ” **real ë¸Œëœì¹˜ì—ì„œë§Œ** ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "ğŸš« **í…ŒìŠ¤íŠ¸ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.**" >> $GITHUB_STEP_SUMMARY
          
          exit 1

  test:
    runs-on: ubuntu-latest
    
    # ë¸Œëœì¹˜ ê²€ì¦ í›„ì—ë§Œ ì‹¤í–‰
    needs: validate-branch
    
    # í…ŒìŠ¤íŠ¸ ì´ë¦„ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ
    name: ${{ inputs.test_target }}
    
    # real ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰
    if: github.ref_name == 'real'
    
    container:
      image: mcr.microsoft.com/playwright/python:v1.45.1-jammy
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --no-cache-dir -r requirements.txt
          playwright install
      
      - name: ğŸ”§ í™˜ê²½ ì„¤ì •
        shell: bash
        env:
          KR1_REAL_DOMAIN: ${{ secrets.KR1_REAL_DOMAIN }}
          JP1_REAL_DOMAIN: ${{ secrets.JP1_REAL_DOMAIN }}
          JP2_REAL_DOMAIN: ${{ secrets.JP2_REAL_DOMAIN }}
        run: |
          cat << EOF > .env
          TEST_ENV=real
          INSTANCE=${{ inputs.instance }}
          KR1_REAL_DOMAIN=${KR1_REAL_DOMAIN}
          JP1_REAL_DOMAIN=${JP1_REAL_DOMAIN}
          JP2_REAL_DOMAIN=${JP2_REAL_DOMAIN}
          PASSWORD=${{ secrets.PASSWORD }}
          HEADLESS=true
          SLOW_MO=0
          EOF
          echo "âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ (ì¸ìŠ¤í„´ìŠ¤: ${{ inputs.instance }}, í™˜ê²½: real - ìš´ì˜ì„œë²„)"
      
      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        id: test_step
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}
          TEST_ENV: real
          INSTANCE: ${{ inputs.instance }}
          KR1_REAL_DOMAIN: ${{ secrets.KR1_REAL_DOMAIN }}
          JP1_REAL_DOMAIN: ${{ secrets.JP1_REAL_DOMAIN }}
          JP2_REAL_DOMAIN: ${{ secrets.JP2_REAL_DOMAIN }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          # ì´ëª¨ì§€ ì œê±°í•˜ê³  ì‹¤ì œ í…ŒìŠ¤íŠ¸ ë§¤í•‘
          case "${{ inputs.test_target }}" in
            "ğŸ¯ ì „ì²´ í…ŒìŠ¤íŠ¸")
              echo "ğŸš€ ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/ -v --browser=chromium
              ;;
            "ğŸ‘¤ êµ¬ì„±ì› (User)")
              echo "ğŸ‘¤ êµ¬ì„±ì› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_user.py -v --browser=chromium
              ;;
            "ğŸ“‡ ì™¸ë¶€ ì—°ë½ì²˜ (Contact)")
              echo "ğŸ“‡ ì™¸ë¶€ ì—°ë½ì²˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_contact.py -v --browser=chromium
              ;;
            "ğŸ‘¥ ê·¸ë£¹ (Group)")
              echo "ğŸ‘¥ ê·¸ë£¹ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_group.py -v --browser=chromium
              ;;
            "ğŸŒ ì™¸ë¶€ ê·¸ë£¹ (External Group)")
              echo "ğŸŒ ì™¸ë¶€ ê·¸ë£¹ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_external_group.py -v --browser=chromium
              ;;
            "ğŸ¢ ì¡°ì§ (OrgUnit)")
              echo "ğŸ¢ ì¡°ì§ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_orgunit.py -v --browser=chromium
              ;;
            "ğŸ’¼ ì§ì±… (Position)")
              echo "ğŸ’¼ ì§ì±… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_position.py -v --browser=chromium
              ;;
            "ğŸ“Š ì§ê¸‰ (Level)")
              echo "ğŸ“Š ì§ê¸‰ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_level.py -v --browser=chromium
              ;;
            "ğŸ“Œ ìƒíƒœ (Status)")
              echo "ğŸ“Œ ìƒíƒœ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_status.py -v --browser=chromium
              ;;
            "ğŸ‘” ì‚¬ìš©ì ìœ í˜• (UserType)")
              echo "ğŸ‘” ì‚¬ìš©ì ìœ í˜• í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_usertype.py -v --browser=chromium
              ;;
            "ğŸ·ï¸ íšŒì‚¬ íƒœê·¸ (Company Tag)")
              echo "ğŸ·ï¸ íšŒì‚¬ íƒœê·¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_company_tag.py -v --browser=chromium
              ;;
            "ğŸ“ MY íƒœê·¸ (MY Tag)")
              echo "ğŸ“ MY íƒœê·¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_my_tag.py -v --browser=chromium
              ;;
            "ğŸ“ ì—°ë½ì²˜ ì»¤ìŠ¤í…€ í•„ë“œ (Contact Custom Field)")
              echo "ğŸ“ ì—°ë½ì²˜ ì»¤ìŠ¤í…€ í•„ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_contact_custom_field.py -v --browser=chromium
              ;;
            "ğŸ‘¨â€ğŸ’¼ êµ¬ì„±ì› ì»¤ìŠ¤í…€ í•„ë“œ (Users Custom Field)")
              echo "ğŸ‘¨â€ğŸ’¼ êµ¬ì„±ì› ì»¤ìŠ¤í…€ í•„ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
              pytest tests/test_users_custom_field.py -v --browser=chromium
              ;;
          esac
      
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (ì„±ê³µ)
        if: success()
        run: |
          echo "### ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„ íƒí•œ í…ŒìŠ¤íŠ¸:** ${{ inputs.test_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¸ìŠ¤í„´ìŠ¤:** ${{ inputs.instance }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ í™˜ê²½:** real (ìš´ì˜ì„œë²„)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œë¼ìš°ì €:** chromium" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ë²ˆí˜¸:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âœ… ê²°ê³¼: ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (ì‹¤íŒ¨)
        if: failure()
        run: |
          echo "### ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„ íƒí•œ í…ŒìŠ¤íŠ¸:** ${{ inputs.test_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì¸ìŠ¤í„´ìŠ¤:** ${{ inputs.instance }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ í™˜ê²½:** real (ìš´ì˜ì„œë²„)" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œë¼ìš°ì €:** chromium" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ë²ˆí˜¸:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### âŒ ê²°ê³¼: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ìœ„ ë¡œê·¸ì—ì„œ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY